<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics - Planning Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-slate-50 min-h-screen">
    
    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <i data-lucide="brain" class="text-emerald-400"></i>
                <h1 class="text-xl font-bold">Planning Platform</h1>
            </div>
            
            <nav class="hidden md:flex items-center gap-6">
                <a href="dashboard.html" class="hover:text-emerald-400 transition">Dashboard</a>
                <a href="discover.html" class="hover:text-emerald-400 transition">Discover</a>
                <a href="stats.html" class="text-emerald-400">Statistics</a>
                <a href="profile.html" class="hover:text-emerald-400 transition">Profile</a>
            </nav>

            <div class="flex items-center gap-3">
                <button onclick="Auth.logout()" class="hover:text-red-400 transition">
                    <i data-lucide="log-out" size="20"></i>
                </button>
                <img id="user-avatar" src="https://ui-avatars.com/api/?name=User" 
                     class="w-10 h-10 rounded-full border-2 border-emerald-400">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold text-slate-900 mb-2">Your Productivity Statistics</h2>
                <p class="text-slate-600">Track your progress and analyze your performance</p>
            </div>
            <div>
                <select id="period-select" class="px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="changePeriod()">
                    <option value="7">Last 7 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-slate-600 text-sm">Total Tasks</span>
                    <i data-lucide="list-checks" class="text-blue-500" size="20"></i>
                </div>
                <p class="text-3xl font-bold text-slate-900" id="metric-total-tasks">0</p>
                <p class="text-xs text-slate-500 mt-1">In selected period</p>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-slate-600 text-sm">Completed</span>
                    <i data-lucide="check-circle" class="text-emerald-500" size="20"></i>
                </div>
                <p class="text-3xl font-bold text-slate-900" id="metric-completed-tasks">0</p>
                <p class="text-xs text-emerald-600 mt-1"><span id="metric-completion-rate">0</span>% completion rate</p>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-slate-600 text-sm">Current Streak</span>
                    <i data-lucide="flame" class="text-orange-500" size="20"></i>
                </div>
                <p class="text-3xl font-bold text-slate-900"><span id="metric-current-streak">0</span> days</p>
                <p class="text-xs text-slate-500 mt-1">Longest: <span id="metric-longest-streak">0</span> days</p>
            </div>

            <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-slate-600 text-sm">Level</span>
                    <i data-lucide="award" class="text-purple-500" size="20"></i>
                </div>
                <p class="text-3xl font-bold text-slate-900" id="metric-level">1</p>
                <p class="text-xs text-slate-500 mt-1"><span id="metric-points">0</span> XP</p>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <!-- Completion Rate Over Time -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Completion Rate Over Time</h3>
                <div class="chart-container">
                    <canvas id="completion-chart"></canvas>
                </div>
            </div>

            <!-- Category Breakdown -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Tasks by Category</h3>
                <div class="chart-container">
                    <canvas id="category-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Weekly Report -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
            <h3 class="text-lg font-bold text-slate-900 mb-4">Weekly Summary</h3>
            <div id="weekly-summary" class="space-y-3">
                <!-- Weekly data will be loaded here -->
            </div>
        </div>

        <!-- Achievements -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                <i data-lucide="trophy" class="text-yellow-500"></i>
                Your Achievements
            </h3>
            <div id="achievements-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Achievements will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/stats.js"></script>
    <script>
        lucide.createIcons();

        let completionChart = null;
        let categoryChart = null;

        // Initialize
        if (Auth.requireAuth()) {
            Auth.initUser();
            loadStatistics();
        }

        async function loadStatistics() {
            const period = document.getElementById('period-select').value;
            
            try {
                // Load dashboard stats
                const dashboardData = await Utils.apiRequest(`/stats/dashboard?period=${period}`);
                updateMetrics(dashboardData.summary);
                updateCompletionChart(dashboardData.stats);

                // Load category breakdown
                const categoryData = await Utils.apiRequest(`/stats/by-category?period=${period}`);
                updateCategoryChart(categoryData.categories);

                // Load weekly report
                const weeklyData = await Utils.apiRequest('/stats/weekly-report');
                updateWeeklySummary(weeklyData);

                // Load achievements
                const user = Utils.getUser();
                const achievementsData = await Utils.apiRequest(`/users/${user.id}/achievements`);
                updateAchievements(achievementsData.achievements);

            } catch (error) {
                console.error('Failed to load statistics:', error);
                Utils.showToast('Failed to load statistics', 'error');
            }
        }

        function updateMetrics(summary) {
            document.getElementById('metric-total-tasks').textContent = summary.totalTasks || 0;
            document.getElementById('metric-completed-tasks').textContent = summary.completedTasks || 0;
            document.getElementById('metric-completion-rate').textContent = summary.completionRate || 0;
            document.getElementById('metric-current-streak').textContent = summary.currentStreak || 0;
            document.getElementById('metric-longest-streak').textContent = summary.longestStreak || 0;
            document.getElementById('metric-level').textContent = summary.level || 1;
            document.getElementById('metric-points').textContent = summary.totalPoints || 0;
        }

        function updateCompletionChart(stats) {
            const ctx = document.getElementById('completion-chart');
            
            if (completionChart) {
                completionChart.destroy();
            }

            const labels = stats.map(s => new Date(s.date).toLocaleDateString('fr-FR', { month: 'short', day: 'numeric' }));
            const data = stats.map(s => parseFloat(s.completion_rate) || 0);

            completionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Completion Rate (%)',
                        data: data,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function updateCategoryChart(categories) {
            const ctx = document.getElementById('category-chart');
            
            if (categoryChart) {
                categoryChart.destroy();
            }

            const labels = categories.map(c => c.category);
            const data = categories.map(c => parseInt(c.total));
            const colors = ['#ef4444', '#10b981', '#3b82f6', '#8b5cf6', '#f59e0b'];

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateWeeklySummary(weeklyData) {
            const container = document.getElementById('weekly-summary');
            
            container.innerHTML = weeklyData.dailyStats.map(day => {
                const date = new Date(day.date);
                const completionRate = parseFloat(day.completion_rate) || 0;
                const progressColor = completionRate >= 70 ? 'bg-emerald-500' : completionRate >= 40 ? 'bg-yellow-500' : 'bg-red-500';
                
                return `
                    <div class="flex items-center gap-4">
                        <div class="w-24 text-sm font-medium text-slate-700">
                            ${date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' })}
                        </div>
                        <div class="flex-1">
                            <div class="w-full bg-slate-200 rounded-full h-6">
                                <div class="${progressColor} h-6 rounded-full flex items-center justify-center text-white text-xs font-bold" 
                                     style="width: ${completionRate}%">
                                    ${completionRate.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        <div class="text-sm text-slate-600">
                            ${day.completed_tasks}/${day.total_tasks} tasks
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAchievements(achievements) {
            const container = document.getElementById('achievements-grid');
            
            if (achievements.length === 0) {
                container.innerHTML = '<p class="text-slate-500 col-span-full text-center py-8">No achievements yet. Keep working!</p>';
                return;
            }

            container.innerHTML = achievements.map(achievement => `
                <div class="bg-gradient-to-br from-yellow-50 to-orange-50 border border-yellow-200 rounded-xl p-4 text-center">
                    <i data-lucide="award" class="text-yellow-500 mx-auto mb-2" size="32"></i>
                    <h4 class="font-bold text-slate-900 mb-1">${achievement.badge_name}</h4>
                    <p class="text-xs text-slate-600">${achievement.badge_description}</p>
                    <p class="text-xs text-slate-400 mt-2">
                        ${new Date(achievement.unlocked_at).toLocaleDateString('fr-FR')}
                    </p>
                </div>
            `).join('');

            lucide.createIcons();
        }

        function changePeriod() {
            loadStatistics();
        }
    </script>
</body>
</html>
